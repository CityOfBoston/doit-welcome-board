<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bluebikes Simple Display</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            width: 1080px;
            height: 1920px;
            overflow: hidden;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            color: #333;
            padding: 60px;
        }

        h1 {
            font-size: 80px;
            margin-bottom: 60px;
            text-align: center;
            color: #1c4587;
            border-bottom: 4px solid #ccc;
            padding-bottom: 30px;
        }

        .station-card {
            background: white;
            border: 2px solid #ddd;
            border-radius: 20px;
            margin-bottom: 40px;
            padding: 40px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .station-name {
            font-size: 50px;
            font-weight: bold;
            margin-bottom: 30px;
            color: #222;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            text-align: center;
            gap: 20px;
        }

        .stat-box {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
        }

        .stat-number {
            display: block;
            font-size: 70px;
            font-weight: bold;
            color: #1c4587;
        }

        .stat-label {
            display: block;
            font-size: 24px;
            text-transform: uppercase;
            color: #666;
            margin-top: 10px;
        }

        /* Debug Log for BrightSign Troubleshooting */
        #debug-log {
            font-family: 'Courier New', monospace;
            font-size: 18px;
            color: #555;
            margin-top: 50px;
            white-space: pre-wrap;
            border-top: 1px solid #ccc;
            padding-top: 20px;
        }
    </style>
</head>
<body>

    <h1>Bluebikes Availability</h1>
    
    <div id="app">
        <!-- Data will render here -->
    </div>

    <!-- On-screen logs to help diagnose why it isn't loading -->
    <div id="debug-log">Initializing...</div>

    <script>
        // --- CONFIGURATION ---
        var TARGET_STATIONS = ['B32008', 'D32009', 'B32032']; 

        // --- HELPER: LOGGING ---
        function log(msg) {
            var el = document.getElementById('debug-log');
            el.innerHTML += '<br>' + msg;
            console.log(msg);
        }

        // --- HELPER: OLD SCHOOL AJAX REQUEST (No Fetch/Promises) ---
        function getJSON(url, successCallback, errorCallback) {
            var xhr = new XMLHttpRequest();
            // Add random number to URL to force BrightSign not to cache
            var cacheBuster = (url.indexOf('?') >= 0 ? '&' : '?') + 't=' + new Date().getTime();
            
            xhr.open('GET', url + cacheBuster, true);
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) { // Done
                    if (xhr.status >= 200 && xhr.status < 300) {
                        try {
                            var data = JSON.parse(xhr.responseText);
                            successCallback(data);
                        } catch (e) {
                            errorCallback("JSON Parse Error on " + url);
                        }
                    } else {
                        errorCallback("HTTP Error " + xhr.status + " on " + url);
                    }
                }
            };
            
            xhr.onerror = function() {
                errorCallback("Network Error (Check DNS/Internet) on " + url);
            };
            
            xhr.send();
        }

        // --- HELPER: FIND ARRAY ITEM (Polyfill for older browsers) ---
        function findStation(list, key, value) {
            for (var i = 0; i < list.length; i++) {
                if (list[i][key] === value) {
                    return list[i];
                }
            }
            return null;
        }

        // --- MAIN LOGIC ---
        function start() {
            log("Step 1: Fetching Feed List...");
            
            getJSON('https://gbfs.bluebikes.com/gbfs/gbfs.json', function(gbfsData) {
                
                var feeds = gbfsData.data.en.feeds;
                var infoFeed = null;
                var statusFeed = null;

                // Find the URLs manually (No arrow functions)
                for (var i = 0; i < feeds.length; i++) {
                    if (feeds[i].name === 'station_information') infoFeed = feeds[i].url;
                    if (feeds[i].name === 'station_status') statusFeed = feeds[i].url;
                }

                if (!infoFeed || !statusFeed) {
                    log("Error: Could not find feed URLs in GBFS.");
                    return;
                }

                log("Step 2: Fetching Station Info...");
                getJSON(infoFeed, function(infoData) {
                    
                    log("Step 3: Fetching Station Status...");
                    getJSON(statusFeed, function(statusData) {
                        
                        log("Step 4: Rendering Data...");
                        render(infoData, statusData);
                        
                    }, function(err) { log(err); }); // Fail Status
                }, function(err) { log(err); }); // Fail Info
            }, function(err) { log(err); }); // Fail GBFS
        }

        function render(infoJson, statusJson) {
            var container = document.getElementById('app');
            var html = '';
            
            // Loop through our specific target IDs
            for (var i = 0; i < TARGET_STATIONS.length; i++) {
                var targetId = TARGET_STATIONS[i];
                
                // Find matching data
                var info = findStation(infoJson.data.stations, 'short_name', targetId);
                
                if (info) {
                    var status = findStation(statusJson.data.stations, 'station_id', info.station_id);
                    
                    if (status) {
                        var ebikes = status.num_ebikes_available || 0;
                        var totalBikes = status.num_bikes_available || 0;
                        var classic = totalBikes - ebikes;
                        var docks = status.num_docks_available || 0;

                        html += '<div class="station-card">';
                        html += '<div class="station-name">' + info.name + '</div>';
                        html += '<div class="stats-grid">';
                        
                        html += '<div class="stat-box">';
                        html += '<span class="stat-number">' + classic + '</span>';
                        html += '<span class="stat-label">Classic</span>';
                        html += '</div>';

                        html += '<div class="stat-box">';
                        html += '<span class="stat-number">' + ebikes + '</span>';
                        html += '<span class="stat-label">E-Bikes</span>';
                        html += '</div>';

                        html += '<div class="stat-box">';
                        html += '<span class="stat-number">' + docks + '</span>';
                        html += '<span class="stat-label">Open Docks</span>';
                        html += '</div>';

                        html += '</div></div>';
                    }
                }
            }

            if (html === '') {
                log("Data loaded, but no matching stations found.");
            } else {
                container.innerHTML = html;
                log("Success.");
                // Hide log on success after 2 seconds
                setTimeout(function() { 
                    document.getElementById('debug-log').style.display = 'none'; 
                }, 2000);
            }
        }

        // Start the process
        start();

    </script>
</body>
</html>
