<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>City of Boston Department Display</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            font-family: Inter, -apple-system, "system-ui", "Segoe UI", Helvetica, Arial, sans-serif;
            overflow: hidden; 
        }
        
        .content-item {
            transition: opacity 0.7s ease-in-out;
            opacity: 0;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .content-item.active { opacity: 1; z-index: 1; }
        .content-item:not(.active) { z-index: 0; }
        
        .content-item img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        
        .panel-shadow {
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07);
        }

        #transit-cycler {
            display: grid;
        }
        .transit-panel {
            grid-area: 1 / 1;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            opacity: 0;
            transform: translateY(15px);
            pointer-events: none;
        }
        .transit-panel.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(-360deg); }
        }

        .rotating {
            animation: spin 1.2s linear;
            transform-origin: center;
        }

        /* === Carousel UI === */
        #displayContainer { position: relative; }

        .carousel-overlay{
        position:absolute; inset:0;
        pointer-events:none;
        background: linear-gradient(to bottom, rgba(0,0,0,0.06), rgba(0,0,0,0.00) 30%, rgba(0,0,0,0.06));
        z-index: 2;
        }

        .carousel-progress{
        position:absolute;
        left:16px; right:16px; bottom:12px;
        height:4px;
        border-radius:9999px;
        background: rgba(255,255,255,0.55);
        border: 1px solid rgba(0,0,0,0.08);
        overflow:hidden;
        z-index: 6;
        pointer-events:none;
        }
        .carousel-progress-bar{
        height:100%;
        width:0%;
        background: rgba(17,24,39,0.85);
        border-radius:9999px;
        transform-origin:left center;
        }

        .carousel-btn{
        position:absolute;
        top:50%;
        transform:translateY(-50%);
        z-index: 7;
        width:44px;
        height:44px;
        border-radius:9999px;
        border:1px solid rgba(209,213,219,0.9);
        background: rgba(255,255,255,0.82);
        color:#111827;
        display:flex;
        align-items:center;
        justify-content:center;
        font-size:28px;
        cursor:pointer;
        backdrop-filter: blur(6px);
        opacity: 0.85;
        }
        .carousel-btn.left{ left:14px; }
        .carousel-btn.right{ right:14px; }

        .carousel-dots{
        position:absolute;
        left:0; right:0;
        bottom:24px;
        z-index:7;
        display:flex;
        justify-content:center;
        gap:8px;
        }
        .carousel-dot{
        width:10px; height:10px;
        border-radius:9999px;
        border:1px solid rgba(0,0,0,0.18);
        background: rgba(255,255,255,0.7);
        cursor:pointer;
        }
        .carousel-dot.active{ background: rgba(17,24,39,0.85); }


        .content-item { transform: translateY(6px) scale(0.995); transition: opacity 0.7s ease-in-out, transform 0.7s ease-in-out; }
        .content-item.active { transform: translateY(0) scale(1); }
    </style>
</head>
<body class="h-screen flex flex-col" style="padding: 16px; background-color: #e5f2ff;">
    <!-- Top Cycling Content Block -->
    <div class="rounded-xl mb-4 relative flex-grow">
        <div id="displayContainer" class="w-full h-full relative overflow-hidden rounded-lg">
            <!-- Cycling content will appear here -->

            <!-- subtle overlay (optional, modern look) -->
            <div class="carousel-overlay"></div>

            <!-- controls -->
            <button id="prevBtn" class="carousel-btn left" aria-label="Previous slide">‹</button>
            <button id="nextBtn" class="carousel-btn right" aria-label="Next slide">›</button>

            <!-- dots -->
            <div id="carouselDots" class="carousel-dots" aria-label="Slide navigation"></div>
        </div>
    </div>
    
    <div class="mb-2 flex items-center gap-2">
        <!-- Badge 1: Updated Status -->
        <div class="inline-flex items-center justify-center bg-gray-100 text-gray-800 font-medium px-2 py-1 rounded-lg border border-gray-300 shadow-md" style="font-size: 13px">
            <span id="update-badge">Initializing...</span>
        </div>

        <!-- Badge 2: Refresh Countdown -->
        <div class="inline-flex items-center justify-center w-38 bg-gray-100 text-gray-800 font-medium px-2 py-1 rounded-lg border border-gray-300 shadow-md" style="font-size: 13px">
            <svg id="refresh-icon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-600 mr-1.5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
            </svg>
            <span id="refresh-badge">Starting...</span>
        </div>
    </div>

    <!-- Bottom Block -->
    <div class="grid grid-cols-2 gap-4 flex-none">
        <!-- LEFT PANEL: MBTA TRANSIT -->
        <div id="transitBlock" class="rounded-xl p-3 flex flex-col panel-shadow" style="background-color: #fefefe;">
            <div class="flex-shrink-0 mb-2 border-b pb-2" style="border-color: #d1d5db;">
                 <div class="flex justify-between items-center min-h-[40px]">
                    <h2 class="font-bold" style="color: #333; font-size: 1.25rem;">MBTA Near City Hall</h2>
                    <img src="https://upload.wikimedia.org/wikipedia/commons/6/64/MBTA.svg" alt="MBTA Logo" class="h-8 w-auto">
                 </div>
            </div>
            
            <div id="transit-cycler" class="flex-grow pt-1">
                <!-- Panel 1: Blue, Red, Orange -->
                <div id="transit-data-primary" class="space-y-1 transit-panel">
                    <div class="rounded-md p-2 border" style="background-color: #F9FAFB; border-color: #d1d5db;"><div class="flex items-center justify-between"><div class="flex items-center gap-3"><span class="h-3 w-3 rounded-full flex-shrink-0" style="background-color: #3b82f6;"></span><div><h3 class="font-medium" style="color: #1e3a8a; font-size: 15px;">Blue Line</h3><p style="font-weight: 500; font-size: 13px; color: #6c6c6c;">Government Center → Wonderland</p></div></div><div class="text-right"><span id="blue-line-times" class="font-bold" style="color: #333333; font-size: 1rem;">Loading...</span></div></div></div>
                    <div class="rounded-md p-2 border" style="background-color: #F9FAFB; border-color: #d1d5db;"><div class="flex items-center justify-between"><div class="flex items-center gap-3"><span class="h-3 w-3 rounded-full flex-shrink-0" style="background-color: #ef4444;"></span><div><h3 class="font-medium" style="color: #1e3a8a; font-size: 15px;">Red Line</h3><p style="font-weight: 500; font-size: 13px; color: #6c6c6c;">Park St → Ashmont</p></div></div><div class="text-right"><span id="red-line-times" class="font-bold" style="color: #333333; font-size: 1rem;">Loading...</span></div></div></div>
                    <div class="rounded-md p-2 border" style="background-color: #F9FAFB; border-color: #d1d5db;"><div class="flex items-center justify-between"><div class="flex items-center gap-3"><span class="h-3 w-3 rounded-full flex-shrink-0" style="background-color: #f97316;"></span><div><h3 class="font-medium" style="color: #1e3a8a; font-size: 15px;">Orange Line</h3><p style="font-weight: 500; font-size: 13px; color: #6c6c6c;">State St → Forest Hills</p></div></div><div class="text-right"><span id="orange-line-times" class="font-bold" style="color: #333333; font-size: 1rem;">Loading...</span></div></div></div>
                </div>

                <!-- Panel 2: Green Lines -->
                <div id="transit-data-green" class="space-y-1 transit-panel">
                    <div class="rounded-md p-2 border" style="background-color: #F9FAFB; border-color: #d1d5db;"><div class="flex items-center justify-between"><div class="flex items-center gap-3"><span class="h-3 w-3 rounded-full flex-shrink-0" style="background-color: #00843D;"></span><div><h3 class="font-medium" style="color: #004b24; font-size: 15px;">Green Line (B)</h3><p style="font-weight: 500; font-size: 13px; color: #6c6c6c;">Government Center → Boston College</p></div></div><div class="text-right"><span id="green-b-line-times" class="font-bold" style="color: #333333; font-size: 1rem;">Loading...</span></div></div></div>
                    <div class="rounded-md p-2 border" style="background-color: #F9FAFB; border-color: #d1d5db;"><div class="flex items-center justify-between"><div class="flex items-center gap-3"><span class="h-3 w-3 rounded-full flex-shrink-0" style="background-color: #00843D;"></span><div><h3 class="font-medium" style="color: #004b24; font-size: 15px;">Green Line (C)</h3><p style="font-weight: 500; font-size: 13px; color: #6c6c6c;">Government Center → Cleveland Circle</p></div></div><div class="text-right"><span id="green-c-line-times" class="font-bold" style="color: #333333; font-size: 1rem;">Loading...</span></div></div></div>
                    <div class="rounded-md p-2 border" style="background-color: #F9FAFB; border-color: #d1d5db;"><div class="flex items-center justify-between"><div class="flex items-center gap-3"><span class="h-3 w-3 rounded-full flex-shrink-0" style="background-color: #00843D;"></span><div><h3 class="font-medium" style="color: #004b24; font-size: 15px;">Green Line (E)</h3><p style="font-weight: 500; font-size: 13px; color: #6c6c6c;">Government Center → Heath St</p></div></div><div class="text-right"><span id="green-e-line-times" class="font-bold" style="color: #333333; font-size: 1rem;">Loading...</span></div></div></div>
                </div>
            </div>
        </div>
        
        <!-- RIGHT PANEL: REAL-TIME BLUEBIKES -->
        <div id="bikeshareBlock" class="rounded-xl p-3 flex flex-col panel-shadow" style="background-color: #fefefe;">
            <div class="flex-shrink-0 mb-2 border-b pb-2" style="border-color: #d1d5db;">
                 <div class="flex justify-between items-center min-h-[40px]">
                    <div class="flex items-center gap-2">
                        <img src="https://cdn.lyft.com/static/bikesharefe/logo/Bluebikes-main.svg" alt="Bluebikes Logo" class="h-6 w-auto">
                        <span class="font-bold" style="color: #333333; font-size: 1.25rem;">Near City Hall</span>
                    </div>
                    <img src="https://assets.boston.gov/icons/dept_icons/boston_bikes_icon.svg" alt="Boston Bikes Logo" class="h-10 w-auto">
                 </div>
            </div>
            <div id="bikeshare-data-container" class="space-y-1 flex-grow pt-1">
                <div class="rounded-md p-2 border" style="background-color: #F9FAFB; border-color: #d1d5db;"><div class="flex items-center justify-between"><h3 id="station-name-0" class="font-medium flex-1 truncate pr-2" style="color: #1e3a8a; font-size: 15px;">Loading...</h3><div class="flex items-baseline justify-end gap-3 text-center flex-shrink-0"><div class="w-12"><span id="station-classic-0" class="block font-bold" style="color: #333333; font-size: 1.25rem;">-</span></div><div class="w-12"><span id="station-ebike-0" class="block font-bold" style="color: #333333; font-size: 1.25rem;">-</span></div><div class="w-12"><span id="station-docks-0" class="block font-bold" style="color: #333333; font-size: 1.25rem;">-</span></div></div></div><div class="flex justify-end gap-3 text-center -mt-1" style="color: #4b5563;"><div class="w-12" style="font-size: 0.75rem;">Classic</div><div class="w-13 flex items-center justify-center gap-1" style="font-size: 0.75rem;"><svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="color: #facc15;"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"></path></svg> Ebikes</div><div class="w-12" style="font-size: 0.75rem;">Docks</div></div></div>
                <div class="rounded-md p-2 border" style="background-color: #F9FAFB; border-color: #d1d5db;"><div class="flex items-center justify-between"><h3 id="station-name-1" class="font-medium flex-1 truncate pr-2" style="color: #1e3a8a; font-size: 15px;">Loading...</h3><div class="flex items-baseline justify-end gap-3 text-center flex-shrink-0"><div class="w-12"><span id="station-classic-1" class="block font-bold" style="color: #333333; font-size: 1.25rem;">-</span></div><div class="w-12"><span id="station-ebike-1" class="block font-bold" style="color: #333333; font-size: 1.25rem;">-</span></div><div class="w-12"><span id="station-docks-1" class="block font-bold" style="color: #333333; font-size: 1.25rem;">-</span></div></div></div><div class="flex justify-end gap-3 text-center -mt-1" style="color: #4b5563;"><div class="w-12" style="font-size: 0.75rem;">Classic</div><div class="w-13 flex items-center justify-center gap-1" style="font-size: 0.75rem;"><svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="color: #facc15;"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"></path></svg> Ebikes</div><div class="w-12" style="font-size: 0.75rem;">Docks</div></div></div>
                <div class="rounded-md p-2 border" style="background-color: #F9FAFB; border-color: #d1d5db;"><div class="flex items-center justify-between"><h3 id="station-name-2" class="font-medium flex-1 truncate pr-2" style="color: #1e3a8a; font-size: 15px;">Loading...</h3><div class="flex items-baseline justify-end gap-3 text-center flex-shrink-0"><div class="w-12"><span id="station-classic-2" class="block font-bold" style="color: #333333; font-size: 1.25rem;">-</span></div><div class="w-12"><span id="station-ebike-2" class="block font-bold" style="color: #333333; font-size: 1.25rem;">-</span></div><div class="w-12"><span id="station-docks-2" class="block font-bold" style="color: #333333; font-size: 1.25rem;">-</span></div></div></div><div class="flex justify-end gap-3 text-center -mt-1" style="color: #4b5563;"><div class="w-12" style="font-size: 0.75rem;">Classic</div><div class="w-13 flex items-center justify-center gap-1" style="font-size: 0.75rem;"><svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="color: #facc15;"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"></path></svg> Ebikes</div><div class="w-12" style="font-size: 0.75rem;">Docks</div></div></div>
            </div>
        </div>
    </div>

    <script>
        const contentLinks = [ { type: 'image', primary: "https://raw.githubusercontent.com/CityOfBoston/doit-welcome-board/main/DoITTitleSlide.png", duration: 15}, { type: 'image', primary: "https://raw.githubusercontent.com/CityOfBoston/doit-welcome-board/main/ProjectGreenLight.png", duration: 15}, { type: 'image', primary: "https://raw.githubusercontent.com/CityOfBoston/doit-welcome-board/main/WickedFreeWi-Fi.png", altText: "Wicked Free Wi-Fi Advertisement", duration: 15}, { type: 'image', primary: "https://raw.githubusercontent.com/CityOfBoston/doit-welcome-board/refs/heads/main/AccessBostonFY25_WelcomeBoardGraphic.png", duration: 15}, { type: 'image', primary: "https://raw.githubusercontent.com/CityOfBoston/doit-welcome-board/main/MayorsChallenge.png", duration: 15}, { type: 'image', primary: "https://raw.githubusercontent.com/CityOfBoston/doit-welcome-board/main/Boston250.png", duration: 15}, { type: 'image', primary: "https://raw.githubusercontent.com/CityOfBoston/doit-welcome-board/refs/heads/main/ClimateTechRFI.png", duration: 15} ];
        let currentIndex = 0;
        let cycleTimeout = null;
        let paused = false;

        const container = document.getElementById("displayContainer");
        const prevBtn = document.getElementById("prevBtn");
        const nextBtn = document.getElementById("nextBtn");
        const dotsEl = document.getElementById("carouselDots");

        function createContentElement(item) {
        let element;
        if (item.type === 'iframe') {
            element = document.createElement('iframe');
            element.src = item.primary;
            element.title = item.altText || 'Embedded content';
            element.loading = 'lazy';
            element.style.width = '100%';
            element.style.height = '100%';
            element.style.border = '0';
        } else if (item.type === 'image') {
            element = document.createElement('img');
            element.src = item.primary;
            element.alt = item.altText || '';
            element.loading = 'eager';
        }
        return element;
        }

        function ensureSlide(index) {
        let contentWrapper = container.querySelector(`.content-item[data-index="${index}"]`);
        if (!contentWrapper) {
            contentWrapper = document.createElement('div');
            contentWrapper.className = 'content-item';
            contentWrapper.setAttribute('data-index', String(index));
            const contentElement = createContentElement(contentLinks[index]);
            if (contentElement) contentWrapper.appendChild(contentElement);
            container.appendChild(contentWrapper);
        }
        return contentWrapper;
        }

        function setActiveSlide(index) {
        ensureSlide(index);

        const currentActive = container.querySelector('.content-item.active');
        if (currentActive) currentActive.classList.remove('active');

        const target = container.querySelector(`.content-item[data-index="${index}"]`);
        if (target) setTimeout(() => target.classList.add('active'), 50);

        // dots
        if (dotsEl) {
            dotsEl.querySelectorAll('.carousel-dot').forEach((d, i) => {
            d.classList.toggle('active', i === index);
            });
        }
        }

        function renderDots() {
        if (!dotsEl) return;
        dotsEl.innerHTML = '';
        contentLinks.forEach((_, i) => {
            const dot = document.createElement('button');
            dot.type = 'button';
            dot.className = 'carousel-dot' + (i === currentIndex ? ' active' : '');
            dot.setAttribute('aria-label', `Go to slide ${i + 1}`);
            dot.addEventListener('click', () => goTo(i, true));
            dotsEl.appendChild(dot);
        });
        }

        function scheduleNext() {
        if (cycleTimeout) clearTimeout(cycleTimeout);

        const seconds = contentLinks[currentIndex].duration ?? 15;
        cycleTimeout = setTimeout(() => {
            if (!paused) goTo(currentIndex + 1, false);
            else scheduleNext(); // keep checking while paused
        }, seconds * 1000);
        }

        function goTo(index, resetTimer = true) {
        currentIndex = (index + contentLinks.length) % contentLinks.length;
        setActiveSlide(currentIndex);
        if (resetTimer) scheduleNext();
        }

        function startCycle() {
        renderDots();
        setActiveSlide(currentIndex);
        scheduleNext();

        if (nextBtn) {
            nextBtn.addEventListener('click', (e) => {
            e.preventDefault();
            goTo(currentIndex + 1, true);
            });
        }
        if (prevBtn) {
            prevBtn.addEventListener('click', (e) => {
            e.preventDefault();
            goTo(currentIndex - 1, true);
            });
        }

        // optional: pause on hover
        container.addEventListener('mouseenter', () => { paused = true; });
        container.addEventListener('mouseleave', () => { paused = false; });

        // optional: keyboard
        window.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowRight') goTo(currentIndex + 1, true);
            if (e.key === 'ArrowLeft') goTo(currentIndex - 1, true);
        });
        }


        function startCycle() {
        renderDots();
        setActiveSlide(currentIndex);
        scheduleNext();

        nextBtn.addEventListener('click', (e) => {
        e.preventDefault();
        goTo((currentIndex + 1) % contentLinks.length, true);
        });

        prevBtn.addEventListener('click', (e) => {
        e.preventDefault();
        goTo((currentIndex - 1 + contentLinks.length) % contentLinks.length, true);
        });

        container.addEventListener('mouseenter', () => { paused = true; });
        container.addEventListener('mouseleave', () => { paused = false; });

        window.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowRight') goTo(currentIndex + 1, true);
            if (e.key === 'ArrowLeft') goTo(currentIndex - 1, true);
        });
        } 
        const MASTER_REFRESH_SECONDS = 20;
        const TRANSIT_SWITCH_SECONDS = 10;
        const MBTA_API_KEY = 'ec5c0e06114d498ab788b12888f05df2'; 
        
        let isInitialLoad = true;
        
        function formatPredictionTime(prediction) {
            const attributes = prediction.attributes;
            if (attributes.status) {
                return attributes.status.length > 15 ? 'Delayed' : attributes.status;
            }
            const effectiveTime = attributes.arrival_time || attributes.departure_time;
            if (!effectiveTime) return null;
            const now = new Date();
            const arrival = new Date(effectiveTime);
            const seconds = Math.round((arrival - now) / 1000);
            if (seconds < 0) return null;
            if (seconds <= 30) {
                return 'ARR';
            }
            const minutes = Math.round(seconds / 60);
            return `${minutes} min`;
        }
        
        // *** MODIFIED: Added sort=departure_time to the API call ***
        async function getPredictions(route, stop, direction) { 
            const url = `https://api-v3.mbta.com/predictions?filter[route]=${route}&filter[stop]=${stop}&filter[direction_id]=${direction}&sort=departure_time&page[limit]=3`; 
            try { 
                const response = await fetch(url, {
                    headers: { 'x-api-key': MBTA_API_KEY }
                }); 
                if (!response.ok) throw new Error(`API call failed: ${response.status}`); 
                const data = await response.json(); 
                return data.data || []; 
            } catch (error) { 
                console.error(`Error fetching MBTA data for ${route} at ${stop}:`, error); 
                return []; 
            } 
        }
        
        // *** MODIFIED: Removed the redundant client-side sorting ***
        async function updateLiveTransitData() {
            const lines = [
                { id: 'blue-line', route: 'Blue', stop: 'place-gover', direction: 0 },
                { id: 'red-line', route: 'Red', stop: 'place-pktrm', direction: 1 },
                { id: 'orange-line', route: 'Orange', stop: 'place-state', direction: 1 },
                { id: 'green-b-line', route: 'Green-B', stop: 'place-gover', direction: 0 },
                { id: 'green-c-line', route: 'Green-C', stop: 'place-gover', direction: 0 },
                { id: 'green-e-line', route: 'Green-E', stop: 'place-gover', direction: 0 }
            ];

            await Promise.all(lines.map(async (line) => {
                // The API now returns sorted data, so we don't need to sort here.
                const predictions = await getPredictions(line.route, line.stop, line.direction);
                const timeEl = document.getElementById(`${line.id}-times`);

                if (predictions && predictions.length > 0) {
                    const formattedTimes = predictions
                        .filter(p => {
                            if (!p.attributes.departure_time) return false;
                            const effectiveTime = new Date(p.attributes.arrival_time || p.attributes.departure_time);
                            if (isNaN(effectiveTime.getTime())) return false;
                            return (effectiveTime - new Date()) / 1000 >= 0;
                        })
                        .map(p => formatPredictionTime(p))
                        .filter(time => time !== null)
                        .slice(0, 3) // This slice is still useful as a safeguard.
                        .join(', ');

                    timeEl.textContent = formattedTimes || 'N/A';
                } else {
                    timeEl.textContent = 'N/A';
                }
            }));
        }

        async function updateBikeshareData() { const cityHallStationIds = ['B32008', 'D32009', 'B32032']; try { const gbfsResponse = await fetch('https://gbfs.bluebikes.com/gbfs/gbfs.json'); const gbfsData = await gbfsResponse.json(); const stationInfoURL = gbfsData.data.en.feeds.find(feed => feed.name === 'station_information').url; const stationStatusURL = gbfsData.data.en.feeds.find(feed => feed.name === 'station_status').url; const [infoResponse, statusResponse] = await Promise.all([fetch(stationInfoURL), fetch(stationStatusURL)]); const infoData = await infoResponse.json(); const statusData = await statusResponse.json(); const stationNames = {}; infoData.data.stations.forEach(station => { if (cityHallStationIds.includes(station.short_name)) { stationNames[station.short_name] = station.name; } }); const stationStatuses = {}; infoData.data.stations.forEach(stationInfo => { const status = statusData.data.stations.find(s => s.station_id === stationInfo.station_id); if (status && cityHallStationIds.includes(stationInfo.short_name)) { stationStatuses[stationInfo.short_name] = status; } }); cityHallStationIds.forEach((stationId, index) => { const name = stationNames[stationId]; const status = stationStatuses[stationId]; if (name && status) { const ebikes = status.num_ebikes_available || 0; const classicBikes = (status.num_bikes_available || 0) - ebikes; const docks = status.num_docks_available || 0; document.getElementById(`station-name-${index}`).textContent = name; document.getElementById(`station-classic-${index}`).textContent = classicBikes; document.getElementById(`station-ebike-${index}`).textContent = ebikes; document.getElementById(`station-docks-${index}`).textContent = docks; } }); } catch (error) { console.error("Error fetching Bluebikes data:", error); } }
        
        async function updateAllData() {
            const refreshIcon = document.getElementById('refresh-icon');
            if (!isInitialLoad) {
                refreshIcon.classList.add('rotating');
                refreshIcon.addEventListener('animationend', () => {
                    refreshIcon.classList.remove('rotating');
                }, { once: true });
            }
            await Promise.all([ updateLiveTransitData(), updateBikeshareData() ]);
            
            const updateTime = new Date();
            if (isInitialLoad) {
                isInitialLoad = false;
            }
            return updateTime.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
        }

        function startMasterClock(initialUpdateTime) {
            const updateBadgeEl = document.getElementById('update-badge');
            const refreshBadgeEl = document.getElementById('refresh-badge');
            const primaryTransitPanel = document.getElementById('transit-data-primary');
            const greenTransitPanel = document.getElementById('transit-data-green');
            
            let lastUpdatedString = `Updated at ${initialUpdateTime}`;
            let refreshCountdown = MASTER_REFRESH_SECONDS;
            let transitSwitchCountdown = TRANSIT_SWITCH_SECONDS;
            let isPrimaryTransitVisible = true;
            
            primaryTransitPanel.classList.add('active'); 

            const updateStatusText = () => {
                updateBadgeEl.textContent = lastUpdatedString;
                refreshBadgeEl.textContent = `Refreshing in ${refreshCountdown}s`;
            };
            updateStatusText();
            setInterval(async () => {
                refreshCountdown--;
                transitSwitchCountdown--;
                if (refreshCountdown <= 0) {
                    lastUpdatedString = `Updated at ${await updateAllData()}`;
                    refreshCountdown = MASTER_REFRESH_SECONDS;
                }
                if ( transitSwitchCountdown <= 0) {
                    isPrimaryTransitVisible = !isPrimaryTransitVisible;
                    primaryTransitPanel.classList.toggle('active', isPrimaryTransitVisible);
                    greenTransitPanel.classList.toggle('active', !isPrimaryTransitVisible);
                    transitSwitchCountdown = TRANSIT_SWITCH_SECONDS;
                }
                updateStatusText();
            }, 1000);
        }

        async function initializeDashboard() {
            startCycle();
            const initialUpdateTime = await updateAllData();
            startMasterClock(initialUpdateTime);
        }
        initializeDashboard();
    </script>
</body>
</html>
